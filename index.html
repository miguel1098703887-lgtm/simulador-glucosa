<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Cl√≠nico v6.1 (Predictivo + IOB)</title>
    <!-- MQTT para sincronizaci√≥n (Versi√≥n ligera) -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- Chart.js (CDN optimizado) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugins para Zoom y Gestos -->
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --success: #2ecc71;
            --warning: #e67e22;
            --danger: #e74c3c;
            --info: #3498db;
            --ketone: #9b59b6; /* Morado Cetonas */
            --iob: #f1c40f; /* Amarillo IOB */
        }

        body {
            font-family: 'Inter', sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .monitor-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 480px;
            border: 1px solid #333;
        }

        /* Indicador de Estado */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            background: #252525;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            background-color: #555;
            border-radius: 50%;
            margin-right: 6px;
        }
        .connected .status-dot { background-color: var(--success); box-shadow: 0 0 5px var(--success); }
        .disconnected .status-dot { background-color: var(--danger); }

        /* Main Display */
        #flecha-tendencia {
            font-size: 3rem;
            height: 50px;
            margin-top: -15px;
            display: block;
        }

        #valor-glucosa {
            font-size: 6rem;
            font-weight: 700;
            line-height: 1;
            margin: 10px 0;
            letter-spacing: -2px;
            color: #3498db;
            transition: color 0.5s ease;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        /* IOB Display (Nuevo) */
        #iob-container {
            height: 30px;
            margin-top: 5px;
        }
        #iob-display {
            font-size: 1rem;
            color: var(--iob);
            border: 1px solid var(--iob);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
            opacity: 0; /* Oculto por defecto hasta que haya insulina */
            transition: opacity 0.5s;
        }

        .unidad { font-size: 1.5rem; color: var(--text-dim); font-weight: 400; }

        #mensaje-estado {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: inline-block;
            background: #333;
        }

        /* Alerta Cetonas */
        #alerta-cetonas {
            display: none;
            background-color: rgba(155, 89, 182, 0.2);
            color: var(--ketone);
            border: 1px solid var(--ketone);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 15px var(--ketone); }
            100% { opacity: 0.8; }
        }

        /* Bot√≥n Audio */
        #btn-audio {
            background: var(--success);
            color: #000;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.1s;
        }
        #btn-audio:active { transform: scale(0.98); }

        /* Gr√°fico */
        .chart-container {
            position: relative;
            height: 180px;
            width: 100%;
            margin-bottom: 15px;
        }

        /* Historial */
        #historial-container {
            max-height: 120px;
            overflow-y: auto;
            text-align: left;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-size: 0.85rem;
            color: #aaa;
        }
        .log-entry { 
            padding: 4px 0; 
            border-bottom: 1px solid #2a2a2a; 
            display: flex;
            justify-content: space-between;
        }

        /* Panel Docente */
        #panel-docente {
            display: none;
            margin-top: 20px;
            border: 1px solid #444;
            padding: 15px;
            background: #252525;
            border-radius: 12px;
        }

        .control-group {
            margin-bottom: 12px;
        }
        
        .control-label {
            display: block; 
            font-size: 0.8rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            text-align: left;
        }

        input, select {
            background: #111;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 6px;
            font-size: 1rem;
        }

        button.action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .bg-red { background: var(--danger); }
        .bg-orange { background: var(--warning); }
        .bg-blue { background: var(--info); }
        .bg-grey { background: #7f8c8d; }
        .bg-purple { background: var(--ketone); }

        #btn-admin {
            margin-top: 30px;
            background: transparent;
            border: 1px solid #444;
            color: #666;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Clases de Estado */
        .state-normal { color: var(--success); background: rgba(46, 204, 113, 0.1); }
        .state-warn { color: var(--warning); background: rgba(230, 126, 34, 0.1); }
        .state-danger { color: var(--danger); background: rgba(231, 76, 60, 0.1); }

    </style>
</head>
<body>

    <div class="monitor-card">
        <!-- Header -->
        <div class="header">
            <div id="status-badge" class="status-badge disconnected">
                <span class="status-dot"></span> <span id="status-text">Desconectado</span>
            </div>
            <div style="text-align: right;">
                <div id="fecha-pantalla" style="font-weight: bold;">--/--</div>
                <div id="reloj-pantalla">--:--</div>
            </div>
        </div>

        <!-- Audio Trigger -->
        <button id="btn-audio" onclick="habilitarAudio()">üîä Activar Sonido</button>

        <!-- Main Display -->
        <div id="flecha-tendencia">--</div>
        <div id="valor-glucosa">---</div>
        <div id="iob-container"><div id="iob-display">IOB: 0.00 UI</div></div>
        <div class="unidad">mg/dL</div>
        <div id="mensaje-estado">Conectando...</div>
        
        <!-- Alerta Cetonas -->
        <div id="alerta-cetonas">üü£ RIESGO CETOSIS (+300 mg/dL)</div>

        <!-- Chart -->
        <div class="chart-container">
            <canvas id="glucosaChart"></canvas>
        </div>
        
        <div style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">
            üîç Zoom/Pan ‚Ä¢ L√≠nea Punteada = Predicci√≥n 30min
        </div>

        <!-- Log -->
        <div id="historial-container">
            <div style="font-weight: bold; margin-bottom: 5px; color: #fff;">üìí Registro Cl√≠nico</div>
            <div id="lista-eventos"></div>
        </div>

        <!-- Admin Panel -->
        <div id="panel-docente">
            <h3 style="margin-top: 0; color: #fff;">üë®‚Äçüè´ Panel Docente</h3>
            
            <div class="control-group">
                <span class="control-label" style="color: var(--danger)">üíâ INSULINA</span>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="input-insulina" value="5" min="1" max="50" style="width: 60px; text-align: center;">
                    <button class="action-btn bg-red" onclick="emitirEvento('insulina_custom')">Administrar</button>
                </div>
            </div>

            <div class="control-group">
                <span class="control-label" style="color: var(--warning)">üçî INGESTA</span>
                <select id="select-comida" style="width: 100%;">
                    <option value="jugo">üßÉ Jugo (R√°pido +4.0)</option>
                    <option value="manzana">üçé Manzana (Medio +2.0)</option>
                    <option value="pizza">üçï Pizza (Lento +1.5)</option>
                </select>
                <button class="action-btn bg-orange" onclick="emitirEvento('comida')">Registrar</button>
            </div>

            <div class="control-group">
                <span class="control-label" style="color: var(--info)">üèÉ ACTIVIDAD</span>
                <button class="action-btn bg-blue" onclick="emitirEvento('ejercicio')">Iniciar Ejercicio (-2.0)</button>
            </div>

            <button class="action-btn bg-grey" onclick="emitirEvento('reset')">üîÑ Reiniciar Caso</button>
        </div>

        <button id="btn-admin" onclick="activarModoDocente()">Modo Docente</button>
    </div>

    <script>
        // --- SISTEMA OPTIMIZADO V6.1 (Predictivo + IOB) ---
        
        // 1. Configuraci√≥n Global
        const CONFIG = {
            broker: 'wss://broker.emqx.io:8084/mqtt',
            topic: 'johana-enfermeria/monitor-v5', 
            updateInterval: 60000, 
            timezone: 'America/Bogota'
        };

        let state = {
            glucosa: 110.0,
            tendencia: 0.0,
            lastEventId: 0,
            iob: 0.0, // Insulina a Bordo
            lastInsulinTime: 0
        };

        let client, chart, audioCtx;
        let esDocente = false;
        let audioEnabled = false;
        let lastBeep = 0;

        // 2. Audio Engine (Lazy Load)
        function habilitarAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            audioEnabled = true;
            beep(600, 100, 0.1); 
            document.getElementById('btn-audio').style.display = 'none';
        }

        function beep(freq, duration, vol=1.0) {
            if(!audioEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (duration/1000));
            osc.start();
            osc.stop(audioCtx.currentTime + (duration/1000));
        }

        // 3. L√≥gica de Negocio
        function simularFisiologia() {
            const ruido = (Math.random() - 0.5) * 2;
            
            // Decaimiento de IOB (Curva exponencial de absorci√≥n - aprox 20% cada hora simulada)
            // En simulaci√≥n 1 min, decaimiento r√°pido para efectos visuales
            if (state.iob > 0.05) {
                state.iob *= 0.98; // Se consume
            } else {
                state.iob = 0;
            }

            state.glucosa += state.tendencia + ruido;

            if (state.tendencia > 0) state.tendencia -= 0.1;
            if (state.tendencia < 0) state.tendencia += 0.1;

            state.glucosa = Math.max(20, Math.min(600, state.glucosa));
            actualizarUI(state);
        }

        // 4. Conexi√≥n MQTT
        function conectar() {
            const clientId = 'client-' + Math.random().toString(16).substr(2, 6);
            client = mqtt.connect(CONFIG.broker, { 
                clientId, 
                clean: true, 
                reconnectPeriod: 5000 
            });

            client.on('connect', () => {
                document.getElementById('status-badge').className = 'status-badge connected';
                document.getElementById('status-text').innerText = esDocente ? "Transmitiendo" : "En L√≠nea";
                client.subscribe(CONFIG.topic);
                if(esDocente) loopTransmision();
            });

            client.on('message', (topic, msg) => {
                try {
                    const data = JSON.parse(msg.toString());
                    if (data.evt && data.evtId && data.evtId !== state.lastEventId) {
                        logEvento(data.evt);
                        state.lastEventId = data.evtId;
                    }
                    if (!esDocente) actualizarUI(data);
                } catch(e) { console.error(e); }
            });

            client.on('offline', () => {
                document.getElementById('status-badge').className = 'status-badge disconnected';
                document.getElementById('status-text').innerText = "Reconectando...";
            });
        }

        // 5. Ciclo de Transmisi√≥n
        function loopTransmision() {
            simularFisiologia(); 
            setInterval(() => {
                simularFisiologia();
                publicar();
            }, CONFIG.updateInterval);
        }

        function publicar() {
            if(client && client.connected) {
                client.publish(CONFIG.topic, JSON.stringify(state));
            }
        }

        function emitirEvento(tipo) {
            const now = Date.now();
            if (window.lastClickTime && (now - window.lastClickTime < 1000)) return;
            window.lastClickTime = now;

            let msg = "";

            if (tipo === 'insulina_custom') {
                const u = parseFloat(document.getElementById('input-insulina').value) || 0;
                state.tendencia -= (u * 1.5);
                state.iob += u; // Sumar al c√°lculo de IOB
                msg = `üíâ Insulina: ${u} UI`;
            } else if (tipo === 'comida') {
                const val = document.getElementById('select-comida').value;
                const map = { 'jugo': 4.0, 'manzana': 2.0, 'pizza': 1.5 };
                state.tendencia += map[val];
                msg = `üçî Ingesta: ${val.toUpperCase()}`;
            } else if (tipo === 'ejercicio') {
                state.tendencia -= 2.0;
                msg = "üèÉ Ejercicio iniciado";
            } else if (tipo === 'reset') {
                state.glucosa = 110; state.tendencia = 0; state.iob = 0;
                msg = "üîÑ Reset";
            }

            state.evt = msg;
            state.evtId = now;
            
            publicar();
            actualizarUI(state);
        }

        // 6. UI & Render
        function actualizarUI(data) {
            const val = Math.floor(data.glucosa);
            const elVal = document.getElementById('valor-glucosa');
            const elMsg = document.getElementById('mensaje-estado');
            const elFlecha = document.getElementById('flecha-tendencia');

            elVal.innerText = val;
            elMsg.className = ''; 
            document.getElementById('alerta-cetonas').style.display = 'none';

            elVal.style.color = '#3498db'; 

            if (val < 70) {
                elVal.style.color = 'var(--danger)';
                elMsg.innerText = "HIPOGLUCEMIA";
                elMsg.classList.add('state-danger');
                gestionarAlarma(true);
            } else if (val > 300) {
                elVal.style.color = 'var(--ketone)';
                elMsg.innerText = "HIPERGLUCEMIA SEVERA";
                elMsg.style.background = 'rgba(155, 89, 182, 0.2)';
                document.getElementById('alerta-cetonas').style.display = 'block';
                gestionarAlarma(true); 
            } else if (val > 180) {
                elVal.style.color = 'var(--warning)';
                elMsg.innerText = "HIPERGLUCEMIA";
                elMsg.classList.add('state-warn');
                gestionarAlarma(false);
            } else {
                elMsg.innerText = "EN RANGO";
                elMsg.classList.add('state-normal');
            }

            const t = data.tendencia;
            if (t > 2) elFlecha.innerText = "‚¨ÜÔ∏è";
            else if (t > 0.5) elFlecha.innerText = "‚ÜóÔ∏è";
            else if (t < -2) elFlecha.innerText = "‚¨áÔ∏è";
            else if (t < -0.5) elFlecha.innerText = "‚ÜòÔ∏è";
            else elFlecha.innerText = "‚û°Ô∏è";

            // Actualizar IOB Display
            const elIOB = document.getElementById('iob-display');
            if (data.iob && data.iob > 0.1) {
                elIOB.innerText = `IOB: ${data.iob.toFixed(2)} UI`;
                elIOB.style.opacity = 1;
            } else {
                elIOB.style.opacity = 0;
            }

            // Actualizar Gr√°fico + Predicci√≥n
            if(chart) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // 1. A√±adir punto real
                chart.data.labels.push(timeStr);
                chart.data.datasets[0].data.push(val); // Serie Real
                chart.data.datasets[1].data.push(null); // Serie Predicci√≥n (hueco)

                // Limpieza de buffer
                if(chart.data.labels.length > 60) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }

                // 2. Calcular Predicci√≥n (30 min a futuro)
                const lastRealIndex = chart.data.datasets[0].data.length - 1;
                while(chart.data.labels.length > lastRealIndex + 1) {
                    chart.data.labels.pop();
                    chart.data.datasets[0].data.pop();
                    chart.data.datasets[1].data.pop();
                }

                let predVal = val;
                let predTendencia = data.tendencia;
                
                chart.data.datasets[1].data[lastRealIndex] = val; 

                for(let i=1; i<=30; i+=5) { 
                    predVal += (predTendencia * 5); 
                    if (predTendencia > 0) predTendencia -= 0.5; 
                    if (predTendencia < 0) predTendencia += 0.5;
                    
                    const futureTime = new Date(now.getTime() + i*60000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    chart.data.labels.push(futureTime);
                    chart.data.datasets[0].data.push(null);
                    chart.data.datasets[1].data.push(predVal);
                }

                if (!chart.isZoomedOrPanned()) {
                    chart.update('none');
                }
            }
        }

        function gestionarAlarma(esGrave) {
            const now = Date.now();
            if (now - lastBeep < 5000) return;
            if (esGrave) {
                beep(880, 100); setTimeout(()=>beep(880, 100), 150);
            } else {
                beep(440, 300);
            }
            lastBeep = now;
        }

        function logEvento(texto) {
            const hora = new Date().toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit'});
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span>${texto}</span> <span style="font-size:0.7rem; opacity:0.7">${hora}</span>`;
            document.getElementById('lista-eventos').prepend(div);
        }

        // 7. Inicializaci√≥n
        function init() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('reloj-pantalla').innerText = now.toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('fecha-pantalla').innerText = now.toLocaleDateString('es-CO', {day:'numeric', month:'short'});
            }, 1000);

            const ctx = document.getElementById('glucosaChart').getContext('2d');
            Chart.defaults.color = '#555';
            Chart.defaults.borderColor = '#333';
            
            // Configuraci√≥n del Gr√°fico con ZOOM
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], 
                    datasets: [
                        {
                            label: 'Glucosa Real',
                            data: [],
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 3,
                            tension: 0.4,
                            fill: true,
                            order: 1
                        },
                        {
                            label: 'Proyecci√≥n (30 min)',
                            data: [],
                            borderColor: 'rgba(255, 255, 255, 0.5)', // Blanco Fantasma
                            borderDash: [5, 5], // Punteado
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: false,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: { size: 14 },
                            bodyFont: { size: 16, weight: 'bold' },
                            callbacks: {
                                label: function(context) {
                                    return Math.round(context.parsed.y) + ' mg/dL';
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x', // Scroll horizontal
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true }, // Pellizcar en celular
                                mode: 'x',
                            }
                        }
                    },
                    scales: { 
                        y: { min: 20, max: 400, grid: { color: '#333' } }, 
                        x: { 
                            display: true, 
                            grid: { display: false },
                            ticks: { 
                                color: '#666',
                                maxTicksLimit: 6 
                            }
                        } 
                    },
                    animation: false
                }
            });

            // Precargar datos vac√≠os (historial visual)
            const now = Date.now();
            for(let i=30; i>0; i--) {
                const t = new Date(now - (i * 60000)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                chart.data.labels.push(t);
                chart.data.datasets[0].data.push(null);
                chart.data.datasets[1].data.push(null);
            }
            chart.update();

            conectar();
        }

        function activarModoDocente() {
            const pass = prompt("Clave Docente:");
            if(pass === "profe123") {
                esDocente = true;
                document.getElementById('panel-docente').style.display = 'block';
                document.getElementById('btn-admin').style.display = 'none';
                alert("‚úÖ MODO DOCENTE ACTIVO");
                if('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
                loopTransmision();
            } else {
                alert("‚ùå Clave incorrecta");
            }
        }

        window.onload = init;

    </script>
</body>
</html>
